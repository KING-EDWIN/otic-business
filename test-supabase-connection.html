<!DOCTYPE html>
<html>
<head>
    <title>Supabase Connection Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        pre { background-color: #eee; padding: 10px; border-radius: 5px; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .warning { color: orange; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Supabase Connection Test</h1>
    <p>Testing connection to your Supabase instance...</p>
    <pre id="output"></pre>

    <script>
        const SUPABASE_URL = 'https://jvgiyscchxxekcbdicco.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2Z2l5c2NjaHh4ZWtjYmRpY2NvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcxNDc0MTAsImV4cCI6MjA3MjcyMzQxMH0.TPHpZCjKC0Xb-IhrS0mT_2IdS-mqANDjwPsmJCWUAu8';

        const output = document.getElementById('output');

        async function testSupabase() {
            try {
                // Create Supabase client
                const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                output.textContent += '‚úÖ Supabase client created successfully.\n';

                // Test 1: Check if we can access the auth schema
                output.textContent += '\nüîç Test 1: Checking auth schema access...\n';
                try {
                    const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                    if (sessionError) {
                        output.textContent += `‚ö†Ô∏è Session check failed: ${sessionError.message}\n`;
                    } else if (session) {
                        output.textContent += `‚úÖ Active session found for user: ${session.user.email}\n`;
                    } else {
                        output.textContent += '‚ÑπÔ∏è No active session found (this is normal for new users)\n';
                    }
                } catch (error) {
                    output.textContent += `‚ùå Auth schema access failed: ${error.message}\n`;
                }

                // Test 2: Try to access user_profiles table
                output.textContent += '\nüîç Test 2: Testing user_profiles table access...\n';
                try {
                    const { data: profiles, error: profilesError } = await supabase
                        .from('user_profiles')
                        .select('id, email, user_type')
                        .limit(1);

                    if (profilesError) {
                        output.textContent += `‚ùå user_profiles access failed: ${profilesError.message}\n`;
                        output.textContent += `   Error code: ${profilesError.code || 'N/A'}\n`;
                        output.textContent += `   Error details: ${profilesError.details || 'N/A'}\n`;
                        output.textContent += `   Error hint: ${profilesError.hint || 'N/A'}\n`;
                    } else {
                        output.textContent += `‚úÖ user_profiles access successful. Found ${profiles.length} profile(s).\n`;
                        if (profiles.length > 0) {
                            output.textContent += `   Example: ${JSON.stringify(profiles[0])}\n`;
                        }
                    }
                } catch (error) {
                    output.textContent += `‚ùå user_profiles access failed with exception: ${error.message}\n`;
                }

                // Test 3: Try to create a test user (this will fail due to RLS, but we can see the error)
                output.textContent += '\nüîç Test 3: Testing user creation (this will likely fail due to RLS)...\n';
                try {
                    const testEmail = `test-${Date.now()}@example.com`;
                    const { data: authData, error: authError } = await supabase.auth.signUp({
                        email: testEmail,
                        password: 'testpassword123',
                        options: {
                            data: {
                                full_name: 'Test User',
                                user_type: 'individual'
                            }
                        }
                    });

                    if (authError) {
                        output.textContent += `‚ùå User creation failed: ${authError.message}\n`;
                        output.textContent += `   Error code: ${authError.code || 'N/A'}\n`;
                    } else if (authData.user) {
                        output.textContent += `‚úÖ User creation successful: ${authData.user.email}\n`;
                        
                        // Try to create profile
                        const { error: profileError } = await supabase
                            .from('user_profiles')
                            .insert({
                                id: authData.user.id,
                                email: testEmail,
                                full_name: 'Test User',
                                user_type: 'individual',
                                tier: 'basic',
                                email_verified: false
                            });

                        if (profileError) {
                            output.textContent += `‚ùå Profile creation failed: ${profileError.message}\n`;
                            output.textContent += `   Error code: ${profileError.code || 'N/A'}\n`;
                            output.textContent += `   Error details: ${profileError.details || 'N/A'}\n`;
                        } else {
                            output.textContent += `‚úÖ Profile creation successful!\n`;
                        }
                    }
                } catch (error) {
                    output.textContent += `‚ùå User creation failed with exception: ${error.message}\n`;
                }

                // Summary
                output.textContent += '\nüìã SUMMARY:\n';
                output.textContent += 'If you see "access control checks" errors, the issue is with RLS policies.\n';
                output.textContent += 'Run the fix-rls-policies-comprehensive.sql script to resolve this.\n';
                output.textContent += 'If you see "network connection lost" errors, check your internet connection.\n';

            } catch (error) {
                output.textContent += `\n‚ùå Fatal error: ${error.message}\n`;
                console.error(error);
            }
        }

        testSupabase();
    </script>
</body>
</html>

